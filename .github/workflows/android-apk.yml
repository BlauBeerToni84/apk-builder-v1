name: Android Debug APK
on: [workflow_dispatch, push]
jobs:
  build:
    runs-on: ubuntu-latest
    env:
      CI: "true"
      _JAVA_OPTIONS: "-Xmx3g -XX:+UseParallelGC"
      GRADLE_OPTS: "-Xmx3g -Dorg.gradle.jvmargs=-Xmx3g -Dkotlin.daemon.heap.size=1024m"
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install deps (auto)
        run: |
          node -v || true
          npm -v || true
          if command -v corepack >/dev/null 2>&1; then corepack enable || true; fi
          if [ -f pnpm-lock.yaml ]; then
            (corepack prepare pnpm@8 --activate || npm i -g pnpm) && pnpm install --no-frozen-lockfile
          elif [ -f yarn.lock ]; then
            corepack prepare yarn@4 --activate || true
            (yarn install --no-immutable || yarn install)
          elif [ -f package-lock.json ]; then
            (npm ci --legacy-peer-deps || npm i --legacy-peer-deps)
          else
            npm i --legacy-peer-deps
          fi
      - name: Set up Android SDK (API 34)
        uses: android-actions/setup-android@v3
        with:
          api-level: 34
          components: build-tools;34.0.0


      - name: Upload Gradle log (always)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: gradle-log
          path: android/../gradle-build.log
          if-no-files-found: ignore

      - name: Upload outputs folder
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: outputs
          path: |
            _outputs/**
            android/**/outputs/**
          if-no-files-found: warn

      - name: Upload APKs (any module/variant)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: apks
          path: |
            android/app/build/outputs/**/*.apk
            android/**/outputs/**/*.apk
          if-no-files-found: warn
